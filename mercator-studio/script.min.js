(async function(){"use strict";const e=document.createElement("aside"),t=e.attachShadow({mode:"open"}),n=navigator.userAgent.includes("Firefox"),r=document.createElement("main");r.addEventListener("click",()=>r.classList.add("focus"));const a=document.createElement("button");a.textContent="↑ collapse ↑",a.id="collapse",a.addEventListener("click",e=>{e.stopPropagation(),r.classList.remove("focus")});const i=document.createElement("button");i.id="minimize",i.title="toggle super tiny mode",i.addEventListener("click",e=>{e.stopPropagation(),r.classList.toggle("minimize")});const s=document.createElement("form"),o=document.createElement("style"),l=`"Google Sans", Roboto, RobotDraft, Helvetica, sans-serif, serif`;o.textContent=`* {box-sizing: border-box;transition: all 200ms;}*:not(input) {user-select: none;}@media (prefers-reduced-motion) {* {transition: all 0s;}}:focus {outline: 0;}main {z-index: 99999;position: fixed;left: 0;top: 0;width: 480px;max-width: 100vw;height: auto;min-height: 100vh;display: flex;flex-direction: column;justify-content: space-between;background: white;transform: translateY(calc(-100% + 3rem));box-shadow: 0 .1rem .25rem #0004;border-radius: 0 0 .75rem 0;padding: 1rem 1rem 0 1rem;overflow: hidden;font-family: ${l};font-size: 1rem;cursor: pointer;}button{font-family: inherit;font-size: .8rem;}main #collapse {background: white;cursor: pointer;margin-bottom: .5rem;}main.focus {transform: none;border-radius: 0;height: 100vh;padding: 1rem;cursor: default;overflow: hidden scroll;}main.focus #minimize{display: none;}main.minimize {width: 1rem;padding-right: 0;}#minimize {font-family: inherit;font-size: .5rem;font-weight: bold;color: #444;margin-left: -1rem;flex: 0 0 1rem;width: 1rem;text-align: center;border: 0;background: white;cursor: pointer;overflow-wrap: anywhere;}#minimize::before{content: "◀";transition: inherit;}#minimize:hover::before,.minimize #minimize::before{margin-left: -2px;}.minimize #minimize::before{content: "▶";}.minimize #minimize:hover::before{margin-left: 0;}#previews {margin-top: 1rem;height: 3rem;display: flex;}#previews>video,#previews>canvas {height: 100%;width: auto;background-image: linear-gradient(90deg,hsl( 18, 100%, 68%) 16.7%,\thsl(-10, 100%, 80%) 16.7%,hsl(-10, 100%, 80%) 33.3%,\thsl(  5,  90%, 72%) 33.3%,hsl(  5,  90%, 72%) 50%,\thsl( 48, 100%, 75%) 50%,hsl( 48, 100%, 75%) 66.7%,\thsl( 36, 100%, 70%) 66.7%,hsl( 36, 100%, 70%) 83.3%,\thsl( 20,  90%, 70%) 83.3%);margin-right: 1rem;}#previews>h1 {flex-grow: 1;font-size: 1rem;font-weight: normal;text-align: center;color: #444;line-height: 1.5rem;}:hover>#previews>h1 {transform: translateY(.1rem); /* Tiny nudge downwards */}.focus>#previews>h1 {display: none;}.focus>#previews {height: auto;}.focus>#previews>* {height: auto;width: calc(50% - .5rem);}#presets,label {display: flex;justify-content: space-between;align-items: center;}#presets>* {border: 0;border-radius: 0;background: transparent;flex-grow: 1;}#presets>:first-child {border-radius: 100px 0 0 100px;}#presets>:last-child {border-radius: 0 100px 100px 0;}label {height: 2rem;}label>*{width: calc(100% - 6.5rem);}label>*,#collapse {height: 1.5rem;border-radius: 0.75rem;border: 0.25rem solid lightgray;}label>:hover,#collapse:hover {border: 0.25rem solid gray;}#presets>:hover {background: #0003;}#presets>:focus {background: black;color: white;}#presets:focus-within,#collapse:focus,label>:focus {border-color: black;}textarea {text-align: center;font-family: inherit;font-weight: bold;resize: none;line-height: 1;overflow: hidden;}input[type=range] {-webkit-appearance: none;--gradient: transparent, transparent;--rainbow: hsl(0, 80%, 75%), hsl(30, 80%, 75%), hsl(60, 80%, 75%), hsl(90, 80%, 75%), hsl(120, 80%, 75%), hsl(150, 80%, 75%), hsl(180, 80%, 75%), hsl(210, 80%, 75%), hsl(240, 80%, 75%), hsl(270, 80%, 75%), hsl(300, 80%, 75%), hsl(330, 80%, 75%);background: linear-gradient(90deg, var(--gradient)), linear-gradient(90deg, var(--rainbow));}input[type=range]::-webkit-slider-thumb {-webkit-appearance: none;background: white;width: 1rem;height: 1rem;border: 0.25rem solid black;border-radius: 0.5rem;}input[type=range]:focus::-webkit-slider-thumb {border-color: white;background: black;}input#exposure,input#fog,input#vignette {--gradient: black, #8880, white}input#contrast {--gradient: gray, #8880}input#temperature {--gradient: #88f, #8880, #ff8}input#tint {--gradient: #f8f, #8880, #8f8}input#sepia {--gradient: #8880, #aa8}input#hue,input#rotate {background: linear-gradient(90deg, hsl(0, 80%, 75%), hsl(60, 80%, 75%), hsl(120, 80%, 75%), hsl(180, 80%, 75%), hsl(240, 80%, 75%), hsl(300, 80%, 75%), hsl(0, 80%, 75%), hsl(60, 80%, 75%), hsl(120, 80%, 75%), hsl(180, 80%, 75%), hsl(240, 80%, 75%), hsl(300, 80%, 75%), hsl(0, 80%, 75%))}input#saturate {--gradient: gray, #8880 50%, blue, magenta}input#blur {--gradient: #8880, gray}input#scale,input#x,input#y,input#pillarbox,input#letterbox {--gradient: black, white}`,s.append(o);const c=JSON.parse(window.localStorage.getItem("mercator-studio-values")),d={exposure:0,contrast:0,temperature:0,tint:0,sepia:0,hue:0,saturate:0,blur:0,fog:0,vignette:0,rotate:0,scale:0,x:0,y:0,pillarbox:0,letterbox:0,freeze:!1,text:"",presets:"reset"},u={reset:d,concorde:{contrast:.1,temperature:-.25,tint:-.05,saturate:.2},mono:{exposure:.1,contrast:-.1,sepia:.8,saturate:-1,vignette:-.5},stucco:{contrast:-.1,tint:.1,sepia:.25,saturate:.25,fog:.1},matcha:{exposure:.1,tint:-.75,sepia:1,hue:.2,vignette:.3,fog:.3},deepfry:{contrast:1,saturate:.5}},m=Object.fromEntries(Object.entries(d).map(([e,t])=>{let r;switch(e){case"text":(r=document.createElement("textarea")).placeholder="🌈 Write text here 🌦️",r.addEventListener("input",()=>{r.style.height="auto",r.style.height=r.scrollHeight+"px",h(r,r.value+"".replace(/--/g,"―").replace(/\\sqrt/g,"√").replace(/\\pm/g,"±").replace(/\\times/g,"×").replace(/\\cdot/g,"·").replace(/\\over/g,"∕").replace(/(\^|\_)(\d+)/g,(e,t,n)=>n.split("").map(e=>String.fromCharCode(e.charCodeAt(0)+("_"===t?8272:"1"===e?136:"23".includes(e)?128:8256))).join("")))});break;case"freeze":(r=document.createElement("input")).type="checkbox",r.addEventListener("change",()=>h(r,r.value));break;case"presets":(r=document.createElement("label")).append(...Object.keys(u).map(e=>{const t=document.createElement("button");return t.textContent=e,t.addEventListener("click",t=>{t.preventDefault(),Object.entries(u[e]).forEach(([e,t])=>h(m[e],t))}),t}));break;default:(r=document.createElement("input")).type="range",r.min=["blur","sepia","scale","pillarbox","letterbox"].includes(e)?0:-1,r.max=1;const n=r.max-r.min;r.step=n/32,r.addEventListener("keydown",({ctrlKey:e})=>{e&&(r.step=n/128)}),r.addEventListener("keyup",()=>r.step=n/32),r.addEventListener("input",()=>h(r,r.valueAsNumber)),r.addEventListener("wheel",e=>{e.preventDefault();const t=r.getBoundingClientRect().width,n=-e.deltaX,a=e.deltaY,i=(Math.abs(n)>Math.abs(a)?n:a)/t,s=r.max-r.min,o=r.valueAsNumber+i*s;h(r,Math.round(o/r.step)*r.step)}),r.addEventListener("contextmenu",e=>{e.preventDefault(),h(r,t)})}if(r.classList.add("input"),r.value=c?c[e]:t,!n||!["temperature","tint"].includes(e)){let t=document.createElement("label");t.textContent=r.id=e,s.append(t),t.append(r)}return[e,r]})),p={...d};function h(e,t){p[e.id]=e.value=t,window.localStorage.setItem("mercator-studio-values",JSON.stringify(p))}const g="http://www.w3.org/2000/svg",f=document.createElementNS(g,"svg"),b=document.createElementNS(g,"filter");b.id="filter";const v=document.createElementNS(g,"feComponentTransfer"),x=Object.fromEntries(["r","g","b"].map(e=>{const t=document.createElementNS(g,"feFunc"+e.toUpperCase());return t.setAttribute("type","table"),t.setAttribute("tableValues","0 1"),[e,t]}));v.append(...Object.values(x)),b.append(v),f.append(b);const w=document.createElement("div");w.id="previews";const y=document.createElement("video");y.setAttribute("playsinline",""),y.setAttribute("autoplay",""),y.setAttribute("muted","");const E=Object.fromEntries(["buffer","freeze","display"].map(e=>{const t=document.createElement("canvas"),n=t.getContext("2d");return[e,{element:t,context:n}]})),k=document.createElement("h1");k.textContent="↓ Mercator Studio ↓",w.append(i,y,E.buffer.element,k),r.append(a,s,w),t.append(r,f),document.body.append(e);const z=(e,t)=>(e+1)**t,M=(e,t=32)=>Array(t).fill(0).map((n,r)=>Math.pow(r/(t-1),2**e)).join(" "),S=e=>100*e+"%",L=8;let $=0;class A extends MediaStream{constructor(e){super(e),y.srcObject=e;const t=e.getVideoTracks()[0].getSettings(),r=t.width,a=t.height,i=[r/2,a/2];Object.values(E).forEach(e=>{e.element.width=r,e.element.height=a});E.buffer.buffer;const s=E.buffer.context,o={state:!1,init:!1,image:document.createElement("img"),canvas:E.freeze};m.freeze.addEventListener("change",e=>{o.state=o.init=e.target.checked}),s.textAlign="center",s.textBaseline="middle",clearInterval($),$=setInterval(function(){s.clearRect(0,0,r,a),m.hue.value%=1,m.rotate.value%=1;let e=p,t=S(z(e.exposure,2)),c=S(z(e.contrast,3)),d=n?0:e.temperature,u=n?0:e.tint,h=S(e.sepia),g=360*e.hue+"deg",f=S(L**e.saturate),b=e.blur*r/16+"px",v=e.fog,w=e.vignette,k=2*e.rotate*Math.PI,$=z(e.scale,2),A=e.x*r,j=e.y*a,R=e.pillarbox*r/2,C=e.letterbox*a/2,O=e.text.split("");if(x.r.setAttribute("tableValues",M(u/2-d)),x.g.setAttribute("tableValues",M(-u)),x.b.setAttribute("tableValues",M(d+u/2)),s.filter=`brightness(${t})contrast(${c})${"url(#filter)".repeat(Boolean(d||u))}sepia(${h})hue-rotate(${g})saturate(${f})blur(${b})`,s.translate(...i),k&&s.rotate(k),$-1&&s.scale($,$),(A||j)&&s.translate(A,j),s.translate(-r/2,-a/2),o.init){o.canvas.context.drawImage(y,0,0,r,a);let e=o.canvas.element.toDataURL("image/png");o.image.setAttribute("src",e),o.init=!1}else o.state?s.drawImage(o.image,0,0,r,a):y.srcObject?s.drawImage(y,0,0,r,a):"18, 100%, 68%; -10,100%,80%; 5, 90%, 72%; 48, 100%, 75%; 36, 100%, 70%; 20, 90%, 70%".split(";").forEach((e,t)=>{s.fillStyle=`hsl(${e})`,s.fillRect(t*r/6,0,r/6,a)});if(s.setTransform(1,0,0,1,0,0),s.filter="brightness(1)",v){let e=100*Math.sign(v),t=Math.abs(v);s.fillStyle=`hsla(0,0%,${e}%,${t})`,s.fillRect(0,0,r,a)}if(w){let e=100*Math.sign(w),t=Math.abs(w),n=s.createRadialGradient(...i,0,...i,Math.sqrt((r/2)**2+(a/2)**2));n.addColorStop(0,`hsla(0,0%,${e}%,0`),n.addColorStop(1,`hsla(0,0%,${e}%,${t}`),s.fillStyle=n,s.fillRect(0,0,r,a)}if(R&&(s.clearRect(0,0,R,a),s.clearRect(r,0,-R,a)),C&&(s.clearRect(0,0,r,C),s.clearRect(0,a,r,-C)),O){const e=.9*(r-2*R),t=.9*(a-2*C);s.font=`bold ${e}px ${l}`;let n=s.measureText("0"),o=n.actualBoundingBoxAscent+n.actualBoundingBoxDescent,c=O.reduce((e,t)=>Math.max(e,s.measureText(t).width),0);const d=Math.min(e**2/c,t**2/o/O.length);s.font=`bold ${d}px ${l}`,n=s.measureText("0"),o=1.5*(n.actualBoundingBoxAscent+n.actualBoundingBoxDescent),s.lineWidth=d/8,s.strokeStyle="black",s.fillStyle="white",O.forEach((e,t)=>{let n=i[0],r=i[1]+o*(t-O.length/2+.5);s.strokeText(e,n,r),s.fillText(e,n,r)})}E.display.context.clearRect(0,0,r,a),E.display.context.drawImage(E.buffer.element,0,0)},33);const c=E.display.element.captureStream(30);return c.addEventListener("inactive",()=>{e.getTracks().forEach(e=>{e.stop()}),E.display.context.clearRect(0,0,r,a),y.srcObject=null}),c}}MediaDevices.prototype.old_getUserMedia=MediaDevices.prototype.getUserMedia,MediaDevices.prototype.getUserMedia=(async e=>e&&e.video&&!e.audio?new A(await navigator.mediaDevices.old_getUserMedia(e)):navigator.mediaDevices.old_getUserMedia(e))})()